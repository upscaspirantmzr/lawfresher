<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Vote | Class Election</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h2>Cast Your Vote</h2>
<div class="form">
<input id="roll" placeholder="Enter Your Roll Number" />
<button id="loadBtn">Show Candidates</button>
</div>
<div id="candidates"></div>
<p id="status"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { firebaseConfig } from "./firebaseConfig.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

document.getElementById("loadBtn").addEventListener("click", async ()=>{
  const roll=document.getElementById("roll").value.trim();
  if(!roll){ alert("Enter roll"); return; }

  const voteDoc = await getDoc(doc(db,"votes",roll));
  if(voteDoc.exists()){ document.getElementById("status").innerText="❌ You already voted"; return; }

  const snap = await getDocs(collection(db,"candidates"));
  let html="<h3>Select Candidate:</h3>";
  snap.forEach(c=>{
    const cand = c.data();
    html+=`<button onclick="vote('${c.id}','${roll}')">${cand.name} (${cand.roll})</button><br>`;
  });
  document.getElementById("candidates").innerHTML=html;
});

window.vote=async(cid,roll)=>{
  try{
    await updateDoc(doc(db,"candidates",cid),{votes:increment(1)});
    await setDoc(doc(db,"votes",roll),{candidate:cid});
    document.getElementById("status").innerText="✅ Vote cast";
    document.getElementById("candidates").innerHTML="";
  }catch(err){ document.getElementById("status").innerText="❌ "+err.message; }
};
</script>
</body>
</html>
