<!doctype html>
<html>
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/></head>
<script src="https://cdn.tailwindcss.com"></script>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-5xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Admin Console</h1>
      <div>
        <button id="login" class="px-3 py-2 bg-blue-600 text-white rounded">Login (Google)</button>
        <button id="logout" class="px-3 py-2 bg-gray-200 rounded hidden">Logout</button>
      </div>
    </div>

    <section class="bg-white p-4 rounded shadow mb-4">
      <h2 class="font-semibold">Create Candidate</h2>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <input id="cname" placeholder="Name" class="border p-2 rounded" />
        <input id="csymbol" placeholder="Symbol" class="border p-2 rounded" />
        <input id="cmanifesto" placeholder="Manifesto" class="border p-2 rounded" />
      </div>
      <div class="mt-3">
        <button id="add" class="px-4 py-2 bg-green-600 text-white rounded">Add Candidate</button>
      </div>
    </section>

    <section class="bg-white p-4 rounded shadow mb-4">
      <h2 class="font-semibold">Election Settings</h2>
      <input id="etitle" placeholder="Title" class="border p-2 rounded w-full mt-2" />
      <div class="mt-3 flex gap-2">
        <select id="estatus" class="border p-2 rounded">
          <option value="ready">Ready</option>
          <option value="running">Running</option>
          <option value="ended">Ended</option>
        </select>
        <button id="save" class="px-4 py-2 bg-indigo-600 text-white rounded">Save</button>
      </div>
    </section>

    <section class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold">Votes</h2>
      <div class="mt-3 flex gap-2">
        <button id="download" class="px-4 py-2 bg-yellow-500 rounded">Download CSV</button>
        <button id="reset" class="px-4 py-2 bg-red-600 text-white rounded">Reset Votes</button>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, doc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { firebaseConfig } from "./js/firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById('login'), logoutBtn = document.getElementById('logout');
    const addBtn = document.getElementById('add'), saveBtn = document.getElementById('save');
    const downloadBtn = document.getElementById('download'), resetBtn = document.getElementById('reset');

    loginBtn.addEventListener('click', async ()=> {
      try { await signInWithPopup(auth, provider); location.reload(); } catch(e){ alert('Login failed:'+e.message) }
    });
    logoutBtn.addEventListener('click', async ()=> { await signOut(auth); location.reload(); });

    auth.onAuthStateChanged(user => {
      if (user) { loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden'); } else { loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden'); }
    });

    addBtn.addEventListener('click', async () => {
      const name = document.getElementById('cname').value.trim();
      const symbol = document.getElementById('csymbol').value.trim();
      const manifesto = document.getElementById('cmanifesto').value.trim();
      if (!name) return alert('Name required');
      await addDoc(collection(db,'candidates'), { name, symbol, manifesto });
      alert('Candidate added'); document.getElementById('cname').value=''; document.getElementById('csymbol').value=''; document.getElementById('cmanifesto').value='';
    });

    saveBtn.addEventListener('click', async () => {
      const title = document.getElementById('etitle').value.trim();
      const status = document.getElementById('estatus').value;
      await setDoc(doc(db,'election','meta'), { title, status, startAt: new Date().toISOString() });
      alert('Saved election meta');
    });

    downloadBtn.addEventListener('click', async () => {
      const snap = await getDocs(collection(db,'votes'));
      const rows = [];
      snap.forEach(s => rows.push(s.data()));
      const header = ['voterUid','candidateId','timestamp','voterName','voterEmail'];
      const csv = [header.join(',')].concat(snap.docs.map(d => {
        const r = d.data();
        return [d.id, r.candidateId, r.timestamp, (r.voterName||''), (r.voterEmail||'')].map(v => `"${String(v).replace(/"/g,'""')}"`).join(',');
      })).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'votes.csv'; a.click(); URL.revokeObjectURL(url);
    });

    resetBtn.addEventListener('click', async () => {
      if (!confirm('Delete all votes?')) return;
      const snap = await getDocs(collection(db,'votes'));
      const promises = snap.docs.map(d => deleteDoc(doc(db,'votes',d.id)));
      await Promise.all(promises);
      alert('All votes deleted');
    });
  </script>
</body>
</html>
